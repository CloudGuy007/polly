go_import_path: github.com/emccode/polly

language: go

go:
  - 1.6.1

addons:
  apt:
    packages:
    - rpm

before_script:
  - source .build/dependencies.sh

script:
  - POLLY_DEBUG=true LIBSTORAGE_DEBUG=true make build-all test rpm-all deb-all deploy-prep

notifications:
  - slack: $SLACK_BUILDS

before_deploy:
  - .build/bintray-decapitate.sh

deploy:
  - provider: bintray
    file: .build/bintray-stupid-filtered.json
    user: $BINTRAY_USER
    key: $BINTRAY_KEY
    skip_cleanup: true
    on:
      all_branches: true
      condition: $TRAVIS_TAG =~ ^$ && ($TRAVIS_REPO_SLUG = 'emccode/polly' || $IGNORE_REPO_SLUG_CONDITION = true) && ($TRAVIS_BRANCH = master || $IGNORE_BRANCH_CONDITION = true)

  - provider: bintray
    file: .build/bintray-staged-filtered.json
    user: $BINTRAY_USER
    key: $BINTRAY_KEY
    skip_cleanup: true
    on:
      all_branches: true
      condition: $TRAVIS_TAG =~ -rc[[:digit:]]+$ && ($TRAVIS_REPO_SLUG = 'emccode/polly' || $IGNORE_REPO_SLUG_CONDITION = true)

  - provider: bintray
    file: .build/bintray-stable-filtered.json
    user: $BINTRAY_USER
    key: $BINTRAY_KEY
    skip_cleanup: true
    on:
      all_branches: true
      condition: $TRAVIS_TAG =~ ^v?[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]$ && ($TRAVIS_REPO_SLUG = 'emccode/polly' || $IGNORE_REPO_SLUG_CONDITION = true)

after_success:
  - bash <(curl -s https://codecov.io/bash)
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  - export REPO=emccode/polly
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - docker build -f Dockerfile -t $REPO:$COMMIT .
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - docker push $REPO

cache:
  apt: true
  directories:
    - $HOME/.opt